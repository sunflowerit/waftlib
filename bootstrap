#!/bin/sh
# Version: v.23.08.03

set -e

if [ "$(/bin/id -u)" -eq 0 ] ; then
  /bin/echo "( ERROR ) : Please refrain from using the sudo command with the script."
  exit 1
fi

export SCRIPT_PATH="$(cd "$(/usr/bin/dirname "${0}")" && /bin/pwd)"
export ODOO_WORK_DIRECTORY="$(cd "${SCRIPT_PATH}/../.." && /bin/pwd)"
export DEFAULT_PATH="${PATH}"
cd "${ODOO_WORK_DIRECTORY}"

if [ -z "${LIBRARIES_VERSION_BRANCH}" ] ; then
  if [ "$(/usr/bin/sha1sum "${ODOO_WORK_DIRECTORY}/bootstrap" | /usr/bin/awk '{ print $1}')" = "7b53eaced73cc36675859da32bdfb6c2c1c428fe" ] || \
  [ "$(/usr/bin/sha1sum "${ODOO_WORK_DIRECTORY}/bootstrap" | /usr/bin/awk '{ print $1}')" = "56f5b836e417fa9c6b1d8cdc2afe5a96c91205a5" ] ; then
    /bin/echo "( INFO ) : Update bootstrap script."
    /usr/bin/curl https://raw.githubusercontent.com/sunflowerit/waft/40fa1701a3bd29dd623c2a5a76dedfe66398c28e/bootstrap -o "${ODOO_WORK_DIRECTORY}/bootstrap"
    /bin/echo "( INFO ) : Run bootstrap script again."
    "${ODOO_WORK_DIRECTORY}/bootstrap"
    /bin/echo "( INFO ) : END."
    exit 0
  else
    /bin/echo "( ERROR ) : ${ODOO_WORK_DIRECTORY}/bootstrap file does not have 'LIBRARIES_VERSION_BRANCH' variable! update it by this command:"
    /bin/echo "  /usr/bin/curl https://raw.githubusercontent.com/sunflowerit/waft/master/bootstrap -o ${ODOO_WORK_DIRECTORY}/bootstrap"
    exit 1
  fi
fi

/bin/mkdir -p "${ODOO_WORK_DIRECTORY}/config"
/bin/mkdir -p "${ODOO_WORK_DIRECTORY}/.ignore/auto/addons"
/bin/mkdir -p "${ODOO_WORK_DIRECTORY}/.ignore/odoo"
/bin/mkdir -p "${ODOO_WORK_DIRECTORY}/.ignore/waft"
/bin/mkdir -p "${ODOO_WORK_DIRECTORY}/logfiles"
/bin/mkdir -p "${ODOO_WORK_DIRECTORY}/.python-files"
/bin/mkdir -p "${ODOO_WORK_DIRECTORY}/scripts"
/bin/mkdir -p "${ODOO_WORK_DIRECTORY}/odoo-code"

if [ -f "${ODOO_WORK_DIRECTORY}/config/env-shared" ] ; then
  if [ -f "${ODOO_WORK_DIRECTORY}/config/env-default" ] ; then
    if [ -L "${ODOO_WORK_DIRECTORY}/config/env-default" ] ; then
      . "${ODOO_WORK_DIRECTORY}/config/env-shared" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/config/env-shared!" && exit 1)
      /bin/echo "( INFO ) : Link ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/${ODOO_VERSION}/env-default to ${ODOO_WORK_DIRECTORY}/config/env-default ."
      cd "${ODOO_WORK_DIRECTORY}/config" && /bin/ln -sf "../.ignore/waftlib/templates/${ODOO_VERSION}/env-default"
      . "${ODOO_WORK_DIRECTORY}/config/env-default" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/config/env-default!" && exit 1)
      . "${ODOO_WORK_DIRECTORY}/config/env-shared" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/config/env-shared!" && exit 1)
    else
      /bin/echo "( WARNING ) : ${ODOO_WORK_DIRECTORY}/config/env-default not the default link!"
      . "${ODOO_WORK_DIRECTORY}/config/env-default" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/config/env-default!" && exit 1)
      . "${ODOO_WORK_DIRECTORY}/config/env-shared" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/config/env-shared!" && exit 1)
    fi
  else
    . "${ODOO_WORK_DIRECTORY}/config/env-shared" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/config/env-shared!" && exit 1)
    /bin/echo "( INFO ) : Link ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/${ODOO_VERSION}/env-default to ${ODOO_WORK_DIRECTORY}/config/env-default ."
    cd "${ODOO_WORK_DIRECTORY}/config" && /bin/ln -sf "../.ignore/waftlib/templates/${ODOO_VERSION}/env-default"
    . "${ODOO_WORK_DIRECTORY}/config/env-default" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/config/env-default!" && exit 1)
    . "${ODOO_WORK_DIRECTORY}/config/env-shared" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/config/env-shared!" && exit 1)
  fi
  if [ -f "${ODOO_WORK_DIRECTORY}/.env-secret" ] ; then
    . "${ODOO_WORK_DIRECTORY}/.env-secret" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/.env-secret!" && exit 1)
  else
    /bin/echo "( INFO ) : Copy ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/.env-secret to ${ODOO_WORK_DIRECTORY}/ ."
    /bin/cp "${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/.env-secret" "${ODOO_WORK_DIRECTORY}/config/"
    . "${ODOO_WORK_DIRECTORY}/.env-secret" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/.env-secret!" && exit 1)
  fi
else
  if [ -f "${ODOO_WORK_DIRECTORY}/config/env-default" ] ; then
    export ODOO_VERSION="$(/bin/ls -lha | /bin/grep "${ODOO_WORK_DIRECTORY}/config/env-default" | /usr/bin/cut -d '/' -f3)"
    . "${ODOO_WORK_DIRECTORY}/config/env-default" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/config/env-default!" && exit 1)
  fi
  if [ -f "${ODOO_WORK_DIRECTORY}/.env-secret" ] ; then
    . "${ODOO_WORK_DIRECTORY}/.env-secret" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/.env-secret!" && exit 1)
  else
    /bin/echo "( INFO ) : Copy ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/.env-secret to ${ODOO_WORK_DIRECTORY}/ ."
    /bin/cp "${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/.env-secret" "${ODOO_WORK_DIRECTORY}/config/"
    . "${ODOO_WORK_DIRECTORY}/.env-secret" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/.env-secret!" && exit 1)
  fi
  if [ "${ODOO_VERSION}" = '' ] ; then
    /bin/echo "( ERROR ) : You should define 'ODOO_VERSION' variable in ${ODOO_WORK_DIRECTORY}/.env-secret!"
    exit 1
  else
    if [ "$(/bin/echo "${ODOO_VERSION}" | /bin/sed 's/^[0-9]\+'\.'[0-9]\+$//')" != '' ] ; then
      /bin/echo "( ERROR ) : 'ODOO_VERSION' is not a floating number!"
      exit 1
    else
      if [ ! -f "${ODOO_WORK_DIRECTORY}/config/env-default" ] || [ -L "${ODOO_WORK_DIRECTORY}/config/env-default" ] ; then
        /bin/echo "( INFO ) : Link ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/${ODOO_VERSION}/env-default to ${ODOO_WORK_DIRECTORY}/config/env-default ."
        cd "${ODOO_WORK_DIRECTORY}/config" && /bin/ln -sf "../.ignore/waftlib/templates/${ODOO_VERSION}/env-default"
      else
        /bin/echo "( WARNING ) : ${ODOO_WORK_DIRECTORY}/config/env-default not the default link!"
      fi
      /bin/echo "( INFO ) : Copy ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/${ODOO_VERSION}/env-shared to ${ODOO_WORK_DIRECTORY}/ ."
      /bin/cp "${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/${ODOO_VERSION}/env-shared" "${ODOO_WORK_DIRECTORY}/config/"
      . "${ODOO_WORK_DIRECTORY}/config/env-default" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/config/env-default!" && exit 1)
      . "${ODOO_WORK_DIRECTORY}/config/env-shared" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/config/env-shared!" && exit 1)
      . "${ODOO_WORK_DIRECTORY}/.env-secret" || (/bin/echo "( ERROR ) : Can't load ${ODOO_WORK_DIRECTORY}/.env-secret!" && exit 1)
    fi
  fi
fi

if [ "${ODOO_VERSION}" = '' ] ; then
  /bin/echo "( ERROR ) : You should define 'ODOO_VERSION' variable in ${ODOO_WORK_DIRECTORY}/.env-secret!"
  exit 1
else
  if [ "$(/bin/echo "${ODOO_VERSION}" | /bin/sed 's/^[0-9]\+'\.'[0-9]\+$//')" != '' ] ; then
    /bin/echo "( ERROR ) : 'ODOO_VERSION' is not a floating number!"
    exit 1
  fi
fi

if [ "$(/bin/echo "${ODOO_VERSION}" | /usr/bin/cut -d'.' -f1)" -lt '8' ] ; then
  /bin/echo "( ERROR ) : Waft does not support ${ODOO_VERSION} anymore!"
  exit 1
fi

if [ "$(/bin/echo ${ODOO_VERSION} | /usr/bin/cut -d'.' -f1)" -gt '17' ] ; then
  /bin/echo "( ERROR ) : Waft does not support ${ODOO_VERSION} yet!"
  exit 1
fi

if [ ! -f "${ODOO_WORK_DIRECTORY}/config/python-waft-version" ] || [ -L "${ODOO_WORK_DIRECTORY}/config/python-waft-version" ] ; then
  /bin/echo "( INFO ) : Link ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/python-waft-version to ${ODOO_WORK_DIRECTORY}/config/python-waft-version ."
  cd "${ODOO_WORK_DIRECTORY}/config" && /bin/ln -sf ../.ignore/waftlib/templates/python-waft-version
else
  /bin/echo "( WARNING ) : ${ODOO_WORK_DIRECTORY}/config/python-waft-version not the default link!"
fi
if [ ! -f "${ODOO_WORK_DIRECTORY}/config/python-waft-version" ] ; then
  /bin/echo "( ERROR ) : ${ODOO_WORK_DIRECTORY}/config/python-waft-version should be a file or a link!"
  exit 1
fi

if [ ! -f "${ODOO_WORK_DIRECTORY}/config/python-odoo-version" ] || [ -L "${ODOO_WORK_DIRECTORY}/config/python-odoo-version" ] ; then
  /bin/echo "( INFO ) : Link ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/${ODOO_VERSION}/python-odoo-version to ${ODOO_WORK_DIRECTORY}/config/python-odoo-version ."
  cd "${ODOO_WORK_DIRECTORY}/config" && /bin/ln -sf "../.ignore/waftlib/templates/${ODOO_VERSION}/python-odoo-version"
else
  /bin/echo "( WARNING ) : ${ODOO_WORK_DIRECTORY}/config/python-odoo-version not the default link!"
fi
if [ ! -f "${ODOO_WORK_DIRECTORY}/config/python-odoo-version" ] ; then
  /bin/echo "( ERROR ) : ${ODOO_WORK_DIRECTORY}/config/python-odoo-version should be a file or a link!"
  exit 1
fi

# If user pre-installed a virtual-environment and .venv-odoo already exists,
# we do not need pyenv to install python, nor do we need virtualenv,
# instead the pre-installed version will be used.
if [ -d "${ODOO_WORK_DIRECTORY}/.venv-waft" ] ; then
  /bin/echo "( INFO ) : ${ODOO_WORK_DIRECTORY}/.venv-waft exist!"
else
  export CFLAGS="-O2"
  if [ -f "${ODOO_WORK_DIRECTORY}/.venv-waft" ] ; then
    /bin/echo "( ERROR ) : ${ODOO_WORK_DIRECTORY}/.venv-waft is not a directory!"
    exit 1
  fi
  # Install pyenv
  if [ -f "${ODOO_WORK_DIRECTORY}/.ignore/waft/pyenv" ] ; then
    /bin/echo "( ERROR ) : ${ODOO_WORK_DIRECTORY}/.ignore/waft/pyenv is not a directory!"
    exit 1
  fi
  /bin/rm -fr "${ODOO_WORK_DIRECTORY}/.ignore/waft/.python-version"
  cd "${ODOO_WORK_DIRECTORY}/.ignore/waft" && /bin/ln -sf ../../config/python-waft-version .python-version
  if [ ! -d "${ODOO_WORK_DIRECTORY}/.ignore/waft/pyenv" ] ; then
    /bin/echo "( INFO ) : Clone https://github.com/pyenv/pyenv in ${ODOO_WORK_DIRECTORY}/.ignore/waft/pyenv ."
    /usr/bin/git clone https://github.com/pyenv/pyenv "${ODOO_WORK_DIRECTORY}/.ignore/waft/pyenv"
  else
    /bin/echo "( INFO ) : ${ODOO_WORK_DIRECTORY}/.ignore/waft/pyenv exist! Upgrading to latest..."
    cd "${ODOO_WORK_DIRECTORY}/.ignore/waft/pyenv" && \
    /usr/bin/git checkout master && \
    /usr/bin/git pull origin master || (/bin/echo 'Failed to upgrade pyenv!'; exit 1)
  fi
  cd "${ODOO_WORK_DIRECTORY}/.ignore/waft" && \
  export PATH="${ODOO_WORK_DIRECTORY}/.ignore/waft/pyenv/shims:${ODOO_WORK_DIRECTORY}/.ignore/waft/pyenv/bin:${PATH}" && \
  eval "$("${ODOO_WORK_DIRECTORY}/.ignore/waft/pyenv/bin/pyenv" init -)" && \
  "${ODOO_WORK_DIRECTORY}/.ignore/waft/pyenv/bin/pyenv" install -s
  # Install virtualenv
  export PYTHON_SYSTEM_VERSIONN="$(python -V 2>&1 | /bin/sed 's/^Python //; s/\.[0-9]*$//')"
  /bin/echo "( INFO ) : Python version is ${PYTHON_SYSTEM_VERSIONN}."
  /bin/echo "( INFO ) : Download ${ODOO_WORK_DIRECTORY}/.ignore/waft/pyenv/bin/virtualenv.pyz ."
  /usr/bin/wget --no-check-certificate "https://bootstrap.pypa.io/virtualenv/${PYTHON_SYSTEM_VERSIONN}/virtualenv.pyz" -O "${ODOO_WORK_DIRECTORY}/.ignore/waft/pyenv/bin/virtualenv.pyz" || \
  (/bin/echo '( ERROR ) : Download of virtualenv package failed.' ; exit 1)
  /bin/echo "( INFO ) : Build virtual environment in ${ODOO_WORK_DIRECTORY}/.venv-waft ."
  cd "${ODOO_WORK_DIRECTORY}/.ignore/waft" && python "${ODOO_WORK_DIRECTORY}/.ignore/waft/pyenv/bin/virtualenv.pyz" "${ODOO_WORK_DIRECTORY}/.venv-waft" || (/bin/echo '( ERROR ) : Virtualenv creation failed.' ; exit 1)
fi

export PATH="${DEFAULT_PATH}"

if [ -d "${ODOO_WORK_DIRECTORY}/.venv-odoo" ] ; then
  /bin/echo "( INFO ) : ${ODOO_WORK_DIRECTORY}/.venv-odoo exist!"
else
  if [ -f "${ODOO_WORK_DIRECTORY}/.venv-odoo" ] ; then
    /bin/echo "( ERROR ) : ${ODOO_WORK_DIRECTORY}/.venv-odoo is not a directory!"
    exit 1
  fi
  # Install pyenv
  if [ -f "${ODOO_WORK_DIRECTORY}/.ignore/odoo/pyenv" ] ; then
    /bin/echo "( ERROR ) : ${ODOO_WORK_DIRECTORY}/.ignore/odoo/pyenv is not a directory!"
    exit 1
  fi
  /bin/rm -fr "${ODOO_WORK_DIRECTORY}/.ignore/odoo/.python-version"
  cd "${ODOO_WORK_DIRECTORY}/.ignore/odoo" && /bin/ln -sf ../../config/python-odoo-version .python-version
  if [ ! -d "${ODOO_WORK_DIRECTORY}/.ignore/odoo/pyenv" ] ; then
    /bin/echo "( INFO ) : Clone https://github.com/pyenv/pyenv in ${ODOO_WORK_DIRECTORY}/.ignore/odoo/pyenv ."
    /usr/bin/git clone https://github.com/pyenv/pyenv "${ODOO_WORK_DIRECTORY}/.ignore/odoo/pyenv"
  else
    /bin/echo "( INFO ) : ${ODOO_WORK_DIRECTORY}/.ignore/odoo/pyenv exist! Upgrading to latest..."
    cd "${ODOO_WORK_DIRECTORY}/.ignore/odoo/pyenv" && \
    /usr/bin/git checkout master && \
    /usr/bin/git pull origin master || (/bin/echo '( ERROR ) : Failed to upgrade pyenv!'; exit 1)
  fi
  cd "${ODOO_WORK_DIRECTORY}/.ignore/odoo" && \
  export PATH="${ODOO_WORK_DIRECTORY}/.ignore/odoo/pyenv/shims:${ODOO_WORK_DIRECTORY}/.ignore/odoo/pyenv/bin:${PATH}" && \
  eval "$("${ODOO_WORK_DIRECTORY}/.ignore/odoo/pyenv/bin/pyenv" init -)" && \
  "${ODOO_WORK_DIRECTORY}/.ignore/odoo/pyenv/bin/pyenv" install -s
  # Install virtualenv
  export PYTHON_SYSTEM_VERSIONN="$(python -V 2>&1 | /bin/sed 's/^Python //; s/\.[0-9]*$//')"
  /bin/echo "( INFO ) : Python version is ${PYTHON_SYSTEM_VERSIONN} ."
  /bin/echo "( INFO ) : Download ${ODOO_WORK_DIRECTORY}/.ignore/odoo/pyenv/bin/virtualenv.pyz ."
  /usr/bin/wget --no-check-certificate "https://bootstrap.pypa.io/virtualenv/${PYTHON_SYSTEM_VERSIONN}/virtualenv.pyz" -O "${ODOO_WORK_DIRECTORY}/.ignore/odoo/pyenv/bin/virtualenv.pyz" || \
  (/bin/echo '( ERROR ) : Download of virtualenv package failed.' ; exit 1)
  /bin/echo "( INFO ) : Build virtual environment in ${ODOO_WORK_DIRECTORY}/.venv-odoo ."
  cd "${ODOO_WORK_DIRECTORY}/.ignore/odoo" && python "${ODOO_WORK_DIRECTORY}/.ignore/odoo/pyenv/bin/virtualenv.pyz" "${ODOO_WORK_DIRECTORY}/.venv-odoo" || (/bin/echo '( ERROR ) : Virtualenv creation failed.' ; exit 1)
fi

export PATH="${DEFAULT_PATH}"

if [ ! -f "${ODOO_WORK_DIRECTORY}/build" ] || [ -L "${ODOO_WORK_DIRECTORY}/build" ] ; then
  /bin/echo "( INFO ) : Link ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/build to ${ODOO_WORK_DIRECTORY}/build ."
  cd "${ODOO_WORK_DIRECTORY}" && /bin/ln -sf .ignore/waftlib/build
else
  /bin/echo "( WARNING ) : "${ODOO_WORK_DIRECTORY}/build" not the default link!"
fi

for fiLe in $(/bin/ls -1 "${ODOO_WORK_DIRECTORY}/.ignore/waftlib/scripts/"); do
  if [ ! -f "${ODOO_WORK_DIRECTORY}/scripts/${fiLe}" ] || [ -L "${ODOO_WORK_DIRECTORY}/scripts/${fiLe}" ] ; then
    /bin/echo "( INFO ) : Link ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/scripts/${fiLe} to ${ODOO_WORK_DIRECTORY}/scripts/${fiLe} ."
    cd "${ODOO_WORK_DIRECTORY}/scripts" && /bin/ln -sf "../.ignore/waftlib/scripts/${fiLe}"
    cd "${ODOO_WORK_DIRECTORY}"
  else
    /bin/echo "( WARNING ) : ${ODOO_WORK_DIRECTORY}/scripts/${fiLe} not the default link!"
  fi
done

for fiLe in $(/bin/ls -1 "${ODOO_WORK_DIRECTORY}/.ignore/waftlib/.python-files/"); do
  if [ ! -f "${ODOO_WORK_DIRECTORY}/.python-files/${fiLe}" ] || [ -L "${ODOO_WORK_DIRECTORY}/.python-files/${fiLe}" ] ; then
    /bin/echo "( INFO ) : Link ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/.python-files/${fiLe} to ${ODOO_WORK_DIRECTORY}/.python-files/${fiLe} ."
    cd "${ODOO_WORK_DIRECTORY}/.python-files" && /bin/ln -sf "../.ignore/waftlib/.python-files/${fiLe}"
    cd "${ODOO_WORK_DIRECTORY}"
  else
    /bin/echo "( WARNING ) : ${ODOO_WORK_DIRECTORY}/.python-files/${fiLe} not the default link!"
  fi
done

if [ ! -f "${ODOO_WORK_DIRECTORY}/config/odoo-default.conf" ] || [ -L "${ODOO_WORK_DIRECTORY}/config/odoo-default.conf" ] ; then
  /bin/echo "( INFO ) : Link ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/${ODOO_VERSION}/odoo-default.conf to ${ODOO_WORK_DIRECTORY}/config/odoo-default.conf ."
  cd "${ODOO_WORK_DIRECTORY}/config" && /bin/ln -sf "../.ignore/waftlib/templates/${ODOO_VERSION}/odoo-default.conf"
  cd "${ODOO_WORK_DIRECTORY}"
else
  /bin/echo "( WARNING ) : ${ODOO_WORK_DIRECTORY}/config/odoo-default.conf not the default link!"
fi

if [ ! -f "${ODOO_WORK_DIRECTORY}/config/odoo-code-override-default.conf" ] ; then
  /bin/echo "( INFO ) : Copy ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/odoo-code-override-default.conf to ${ODOO_WORK_DIRECTORY}/config/odoo-code-override-default.conf ."
  /bin/cp "${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/odoo-code-override-default.conf" "${ODOO_WORK_DIRECTORY}/config/"
fi

if [ ! -f "${ODOO_WORK_DIRECTORY}/config/addons.yaml" ] ; then
  /bin/echo "( INFO ) : Copy ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/${ODOO_VERSION}/addons.yaml to ${ODOO_WORK_DIRECTORY}/config/addons.yaml ."
  /bin/cp "${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/${ODOO_VERSION}/addons.yaml" "${ODOO_WORK_DIRECTORY}/config/"
  cd "${ODOO_WORK_DIRECTORY}"
fi

if [ ! -f "${ODOO_WORK_DIRECTORY}/config/odoo-code.yaml" ] ; then
  /bin/echo "( INFO ) : Copy ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/odoo-code.yaml to ${ODOO_WORK_DIRECTORY}/config/odoo-code.yaml ."
  /bin/cp "${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/odoo-code.yaml" "${ODOO_WORK_DIRECTORY}/config/"
  cd "${ODOO_WORK_DIRECTORY}"
fi

if [ -f "${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/${ODOO_VERSION}/requirements-odoo-pre-install-default.txt" ] ; then
  if [ ! -f "${ODOO_WORK_DIRECTORY}/config/requirements-odoo-pre-install-default.txt" ] || [ -L "${ODOO_WORK_DIRECTORY}/config/requirements-odoo-pre-install-default.txt" ]; then
    /bin/echo "( INFO ) : Link ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/${ODOO_VERSION}/requirements-odoo-pre-install-default.txt to ${ODOO_WORK_DIRECTORY}/config/requirements-odoo-pre-install-default.txt ."
    cd "${ODOO_WORK_DIRECTORY}/config" && /bin/ln -sf "../.ignore/waftlib/templates/${ODOO_VERSION}/requirements-odoo-pre-install-default.txt"
  else
    /bin/echo "( WARNING ) : ${ODOO_WORK_DIRECTORY}/config/requirements-odoo-pre-install-default.txt not the default link!"
  fi
fi

if [ ! -f "${ODOO_WORK_DIRECTORY}/config/requirements-odoo-install-default.txt" ] || [ -L "${ODOO_WORK_DIRECTORY}/config/requirements-odoo-install-default.txt" ] ; then
  /bin/echo "( INFO ) : Link ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/${ODOO_VERSION}/requirements-odoo-install-default.txt to ${ODOO_WORK_DIRECTORY}/config/requirements-odoo-install-default.txt ."
  cd "${ODOO_WORK_DIRECTORY}/config" && /bin/ln -sf "../.ignore/waftlib/templates/${ODOO_VERSION}/requirements-odoo-install-default.txt"
else
  /bin/echo "( WARNING ) : ${ODOO_WORK_DIRECTORY}/config/requirements-odoo-install-default.txt not the default link!"
fi

if [ ! -f "${ODOO_WORK_DIRECTORY}/config/requirements-odoo-override-install.txt" ] ; then
  /bin/echo "( INFO ) : Copy ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/requirements-odoo-override-install.txt to ${ODOO_WORK_DIRECTORY}/ ."
  /bin/cp "${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/requirements-odoo-override-install.txt" "${ODOO_WORK_DIRECTORY}/config/"
fi

if [ -f "${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/requirements-waft-pre-install-default.txt" ] ; then
  if [ ! -f "${ODOO_WORK_DIRECTORY}/config/requirements-waft-pre-install-default.txt" ] || [ -L "${ODOO_WORK_DIRECTORY}/config/requirements-waft-pre-install-default.txt" ] ; then
    /bin/echo "( INFO ) : Link ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/requirements-waft-pre-install-default.txt to ${ODOO_WORK_DIRECTORY}/config/requirements-waft-pre-install-default.txt ."
    cd "${ODOO_WORK_DIRECTORY}/config" && /bin/ln -sf "../.ignore/waftlib/templates/requirements-waft-pre-install-default.txt"
  else
    /bin/echo "( WARNING ) : ${ODOO_WORK_DIRECTORY}/config/requirements-waft-pre-install-default.txt not the default link!"
  fi
fi

if [ ! -f "${ODOO_WORK_DIRECTORY}/config/requirements-waft-install-default.txt" ] || [ -L "${ODOO_WORK_DIRECTORY}/config/requirements-waft-install-default.txt" ] ; then
  /bin/echo "( INFO ) : Link ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/templates/requirements-waft-install-default.txt to ${ODOO_WORK_DIRECTORY}/config/requirements-waft-install-default.txt ."
  cd "${ODOO_WORK_DIRECTORY}/config" && /bin/ln -sf ../.ignore/waftlib/templates/requirements-waft-install-default.txt
else
  /bin/echo "( WARNING ) : ${ODOO_WORK_DIRECTORY}/config/requirements-waft-install-default.txt not the default link!"
fi

cd "${ODOO_WORK_DIRECTORY}/.venv-waft/lib/"*"/site-packages" && /bin/mkdir -p venvwaftlib
cd "${ODOO_WORK_DIRECTORY}"
if [ ! -f "${ODOO_WORK_DIRECTORY}/.venv-waft/lib/"*/site-packages/venvwaftlib/__init__.py ] || [ -L "${ODOO_WORK_DIRECTORY}/.venv-waft/lib/"*/site-packages/venvwaftlib/__init__.py ] ; then
  /bin/echo "( INFO ) : Link ${ODOO_WORK_DIRECTORY}/.ignore/waftlib/venvwaftlib/__init__.py to ${ODOO_WORK_DIRECTORY}/.venv-waft/lib/*/site-packages/venvwaftlib/__init__.py ."
  cd "${ODOO_WORK_DIRECTORY}/.venv-waft/lib/"*"/site-packages/venvwaftlib" && /bin/ln -sf ../../../../../.ignore/waftlib/venvwaftlib/__init__.py
  cd "${ODOO_WORK_DIRECTORY}"
else
  /bin/echo "( WARNING ) : ${ODOO_WORK_DIRECTORY}/.venv-odoo/lib/*/site-packages/venvwaftlib/__init__.py not the default link!"
fi

cd "${ODOO_WORK_DIRECTORY}/.venv-odoo/lib/"*"/site-packages" && /bin/mkdir -p venvodoolib
if [ ! -f "${ODOO_WORK_DIRECTORY}/.venv-odoo/lib/"*/site-packages/venvodoolib/__init__.py ] || [ -L "${ODOO_WORK_DIRECTORY}/.venv-odoo/lib/"*/site-packages/venvodoolib/__init__.py ] ; then
  /bin/echo "( INFO ) : Link ${ODOO_WORK_DIRECTORY}/.ignore/odoolib/venvodoolib/__init__.py to ${ODOO_WORK_DIRECTORY}/.venv-odoo/lib/*/site-packages/venvodoolib/__init__.py ."
  cd "${ODOO_WORK_DIRECTORY}/.venv-odoo/lib/"*"/site-packages/venvodoolib" && /bin/ln -sf ../../../../../.ignore/waftlib/venvodoolib/__init__.py
  cd "${ODOO_WORK_DIRECTORY}"
else
  /bin/echo "( WARNING ) : ${ODOO_WORK_DIRECTORY}/.venv-odoo/lib/*/site-packages/venvodoolib/__init__.py not the default link!"
fi

# set permissions
/bin/echo "( INFO ) : Fix files permissions."
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}" || /bin/true
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/config"
/bin/chmod -f 600 "${ODOO_WORK_DIRECTORY}/config/"* || /bin/true
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/.ignore"
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/logfiles"
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/.python-files"
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/.python-files/odoo-addons-install" || /bin/true
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/.python-files/odoo-addons-link" || /bin/true
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/.python-files/odoo-code-aggregate" || /bin/true
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/.python-files/odoo-code-clean" || /bin/true
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/.python-files/odoo-conf-generate" || /bin/true
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/.python-files/odoo-code-pre-clean" || /bin/true
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/.python-files/odoo-modules-translate" || /bin/true
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/scripts"
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/scripts/"* || /bin/true
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/odoo-code"
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/bootstrap" || /bin/true
/bin/chmod -f 700 "${ODOO_WORK_DIRECTORY}/build" || /bin/true
/bin/chmod -f 600 "${ODOO_WORK_DIRECTORY}/.gitignore" || /bin/true
/bin/echo "( INFO ) : END of ${ODOO_WORK_DIRECTORY}/bootstrap script."
